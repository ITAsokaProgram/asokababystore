import { sendRequestGET, sendRequestJSON } from "../../utils/api_helpers.js";

const API_URLS = {
  // PERBAIKAN DISINI: Arahkan ke file get_store_list.php yang baru dibuat
  getCabang: "/src/api/voucher/get_store_list.php",
  insertVoucher: "/src/api/voucher/insert_voucher.php",
};

const state = {
  selectedStores: new Set(),
};

// ... (Sisa kode ke bawah TIDAK PERLU DIUBAH, biarkan sama seperti sebelumnya) ...

// Utility: Pad number with leading zeros (5 digits)
function padNumber(num, size = 5) {
  let s = String(num);
  while (s.length < size) s = "0" + s;
  return s;
}

function renderCabangList(data) {
  const container = document.getElementById("container-cabang");
  container.innerHTML = "";

  if (!data || data.length === 0) {
    container.innerHTML =
      '<div class="text-gray-500 text-xs p-2 text-center">Tidak ada data cabang.</div>';
    return;
  }

  data.forEach((store) => {
    const div = document.createElement("div");
    div.className =
      "flex items-center p-2 hover:bg-pink-50 rounded-md transition-colors cursor-pointer border border-transparent hover:border-pink-100";
    div.innerHTML = `
            <div class="flex items-center h-5">
                <input type="checkbox" id="store_${store.Kd_Store}" value="${store.Kd_Store}" 
                    data-alias="${store.Nm_Alias}"
                    class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500 checkbox-store cursor-pointer">
            </div>
            <label for="store_${store.Kd_Store}" class="ml-3 text-xs cursor-pointer select-none w-full">
                <span class="font-bold text-gray-800 block">${store.Kd_Store}</span>
                <span class="text-gray-500 text-[10px] uppercase tracking-wide">${store.Nm_Store}</span>
            </label>
        `;

    const checkbox = div.querySelector("input");
    checkbox.addEventListener("change", (e) => {
      if (e.target.checked) {
        state.selectedStores.add(e.target.value);
        div.classList.add("bg-pink-50", "border-pink-200");
      } else {
        state.selectedStores.delete(e.target.value);
        div.classList.remove("bg-pink-50", "border-pink-200");
      }
      updateStoreCounter();
      updatePreview();
    });

    container.appendChild(div);
  });
}

function updateStoreCounter() {
  const count = state.selectedStores.size;
  const counterEl = document.getElementById("store-counter");
  counterEl.textContent = `${count} dipilih`;
  if (count > 0) {
    counterEl.classList.remove("badge-warning");
    counterEl.classList.add("badge-success");
  } else {
    counterEl.classList.add("badge-warning");
    counterEl.classList.remove("badge-success");
  }
}

function updatePreview() {
  const manualInput =
    document.getElementById("kode_manual").value.toUpperCase() || "KODE";
  const startNum = parseInt(document.getElementById("start_number").value) || 0;

  // Update Text Elements
  document.getElementById("prev-manual").textContent = manualInput;
  document.getElementById("prev-number").textContent = padNumber(startNum);

  // Menampilkan estimasi range nomor jika qty > 1
  const qty = parseInt(document.getElementById("qty").value) || 1;
  if (qty > 1) {
    const endNum = startNum + qty - 1;
    document.getElementById("prev-number").textContent =
      padNumber(startNum) + " s/d " + padNumber(endNum);
  }
}

async function initPage() {
  // Setup Listeners for Preview
  document
    .getElementById("kode_manual")
    .addEventListener("input", updatePreview);
  document
    .getElementById("start_number")
    .addEventListener("input", updatePreview);
  document.getElementById("qty").addEventListener("input", updatePreview);

  // Setup Date Defaults
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("tgl_awal").value = today;

  // Load Stores
  const loading = document.getElementById("loading-cabang");
  loading.classList.remove("hidden");

  try {
    // Request sekarang mengarah ke get_store_list.php yang baru
    const result = await sendRequestGET(API_URLS.getCabang);
    if (result.success) {
      renderCabangList(result.data);
    } else {
      Swal.fire("Error", "Gagal memuat cabang", "error");
    }
  } catch (error) {
    console.error(error);
    Swal.fire("Error", "Koneksi Error", "error");
  } finally {
    loading.classList.add("hidden");
  }
}

async function submitVoucher(e) {
  e.preventDefault();

  // Validation
  if (state.selectedStores.size === 0) {
    Swal.fire("Perhatian", "Pilih minimal 1 Cabang", "warning");
    return;
  }

  const nilai = document.getElementById("nilai").value;
  const qty = document.getElementById("qty").value;
  const kodeManual = document.getElementById("kode_manual").value;

  if (!nilai || !qty || !kodeManual) {
    Swal.fire("Perhatian", "Mohon lengkapi data detail voucher", "warning");
    return;
  }

  const totalVoucher = state.selectedStores.size * parseInt(qty);

  const result = await Swal.fire({
    title: "Konfirmasi Generate",
    html: `
        <div class="text-left text-sm bg-gray-50 p-4 rounded-lg border border-gray-200">
            <div class="flex justify-between mb-1"><span>Total Store:</span> <b>${
              state.selectedStores.size
            }</b></div>
            <div class="flex justify-between mb-1"><span>Qty per Store:</span> <b>${qty}</b></div>
            <div class="flex justify-between mb-1"><span>Nilai:</span> <b>Rp ${parseInt(
              nilai
            ).toLocaleString("id-ID")}</b></div>
            <hr class="my-2">
            <div class="flex justify-between font-bold text-pink-600"><span>Total Generate:</span> <span>${totalVoucher} Voucher</span></div>
        </div>
        <p class="mt-3 text-xs text-gray-500">Voucher yang sudah ada (duplikat) akan otomatis dilewati.</p>
    `,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "Ya, Generate",
    confirmButtonColor: "#ec4899",
    cancelButtonText: "Batal",
  });

  if (result.isConfirmed) {
    const btn = document.getElementById("btn-submit");
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML =
      '<i class="fas fa-spinner fa-spin"></i> <span>Proses...</span>';

    try {
      const payload = {
        stores: Array.from(state.selectedStores),
        pemilik: document.getElementById("pemilik").value.toUpperCase(),
        nilai: nilai,
        tgl_awal: document.getElementById("tgl_awal").value,
        tgl_akhir: document.getElementById("tgl_akhir").value,
        kode_manual: kodeManual.toUpperCase(),
        start_number: document.getElementById("start_number").value,
        qty: qty,
      };

      const apiRes = await sendRequestJSON(API_URLS.insertVoucher, payload);

      if (apiRes.success) {
        await Swal.fire({
          title: "Berhasil!",
          text: apiRes.message,
          icon: "success",
        });
        window.location.href = "index.php";
      } else {
        Swal.fire("Gagal", apiRes.message, "error");
      }
    } catch (error) {
      console.error(error);
      Swal.fire("Error", error.message || "Terjadi kesalahan server", "error");
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalHTML;
    }
  }
}

initPage();

// Select All / None Handlers
document
  .getElementById("btn-select-all-cabang")
  .addEventListener("click", () => {
    document.querySelectorAll(".checkbox-store").forEach((cb) => {
      cb.checked = true;
      state.selectedStores.add(cb.value);
      cb.closest("div.flex").parentElement.classList.add(
        "bg-pink-50",
        "border-pink-200"
      );
    });
    updateStoreCounter();
  });

document
  .getElementById("btn-deselect-all-cabang")
  .addEventListener("click", () => {
    document.querySelectorAll(".checkbox-store").forEach((cb) => {
      cb.checked = false;
      cb.closest("div.flex").parentElement.classList.remove(
        "bg-pink-50",
        "border-pink-200"
      );
    });
    state.selectedStores.clear();
    updateStoreCounter();
  });

document
  .getElementById("formBuatVoucher")
  .addEventListener("submit", submitVoucher);
