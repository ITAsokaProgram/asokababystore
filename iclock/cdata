<?php
ini_set('display_errors', 0);
ini_set('log_errors', 1);
// Tambahkan ini agar PHP tidak limit saat memproses ribuan baris
ini_set('memory_limit', '512M');
set_time_limit(0);

try {
    $rootDir = realpath(__DIR__ . '/..');
    require_once $rootDir . '/src/utils/Logger.php';
    $logger = new AppLogger('adms_machine.log');

    $method = $_SERVER['REQUEST_METHOD'];
    $queryString = $_SERVER['QUERY_STRING'] ?? '';

    if ($method === 'POST') {
        $rawData = file_get_contents('php://input');
        parse_str($queryString, $params);
        $table = strtoupper($params['table'] ?? '');

        // Log ukuran data yang masuk
        $logger->info("ğŸ“¥ DATA MASUK: Tabel $table, Ukuran: " . strlen($rawData) . " bytes");

        if ($table === 'ATTLOG') {
            $rows = explode("\n", trim($rawData));
            $count = 0;
            foreach ($rows as $line) {
                $line = trim($line);
                if (empty($line))
                    continue;

                $data = explode("\t", $line);
                if (count($data) >= 2) {
                    $pin = trim($data[0]);
                    $time = trim($data[1]);
                    // Di sini Anda bisa masukkan ke Database (INSERT IGNORE)
                    $count++;
                }
            }
            $logger->success("âœ… BERHASIL: $count log absensi diproses.");
        }
        echo "OK";
        exit;
    }

    // ... bagian GET handshake tetap sama ...
    if ($method === 'GET') {
        echo "GET OPTION FROM: 1\r\n";
        echo "Stamp=9999\r\n";
        echo "OpStamp=1\r\n";
        echo "ErrorDelay=30\r\n";
        echo "Delay=10\r\n";
        echo "TransFlag=1111000000\r\n";
        exit;
    }

} catch (Exception $e) {
    error_log($e->getMessage());
}