<?php
ini_set('display_errors', 0);
ini_set('log_errors', 1);
ini_set('memory_limit', '512M');
set_time_limit(0);
require_once __DIR__ . '/../aa_kon_sett.php';
try {
    $rootDir = realpath(__DIR__ . '/..');
    require_once $rootDir . '/src/utils/Logger.php';
    $logger = new AppLogger('adms_machine.log');
    $method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
    $queryString = $_SERVER['QUERY_STRING'] ?? '';
    if ($method === 'POST') {
        $rawData = file_get_contents('php://input');
        parse_str($queryString, $params);
        $table = strtoupper($params['table'] ?? $params['Table'] ?? '');
        if (empty(trim($rawData))) {
            $logger->warning("POST diterima tapi data kosong. Table: $table");
            echo "OK";
            exit;
        }
        $rows = array_filter(array_map('trim', explode("\n", $rawData)));
        $logger->info("ðŸ“¥ Data Received [POST] Table: $table | Rows: " . count($rows));
        foreach ($rows as $line) {
            if (empty($line))
                continue;
            $data = explode("\t", $line);
            if ($table === 'ATTLOG' || $table === 'TRANSACTION' || strpos($table, 'ATT') !== false) {
                if (count($data) >= 4) {
                    $pin = mysqli_real_escape_string($conn, trim($data[0]));
                    $time = mysqli_real_escape_string($conn, trim($data[1]));
                    $status = mysqli_real_escape_string($conn, trim($data[2] ?? '0'));
                    if (empty($pin) || empty($time) || strtoupper($pin) === 'FP' || strtoupper($pin) === 'USERPIC')
                        continue;
                    $resKaryawan = mysqli_query($conn, "SELECT id FROM karyawan WHERE nik = '$pin' LIMIT 1");
                    if ($rowK = mysqli_fetch_assoc($resKaryawan)) {
                        $id_karyawan = $rowK['id'];
                        $query = "INSERT INTO absen (id_karyawan, jam, status) VALUES ('$id_karyawan', '$time', '$status')";
                        if (mysqli_query($conn, $query)) {
                            $logger->success("âœ… ABSEN SAVED: NIK=$pin | Time=$time");
                        }
                    } else {
                        $logger->warning("âŒ ABSEN GAGAL: NIK $pin tidak ditemukan di tabel karyawan");
                    }
                }
            } else {
                if (count($data) >= 2) {
                    $pin = trim($data[0]);
                    $name = trim($data[1]);
                } else {
                    $line_temp = str_replace(" ", "&", $line);
                    parse_str($line_temp, $userData);
                    $pin = $userData['PIN'] ?? '';
                    $name = $userData['Name'] ?? $userData['FileName'] ?? '';
                }
                $cleanPin = strtoupper(trim($pin));
                if (empty($cleanPin) || $cleanPin === 'FP' || $cleanPin === 'USERPIC')
                    continue;
                $pinEscaped = mysqli_real_escape_string($conn, $cleanPin);
                $nameEscaped = mysqli_real_escape_string($conn, $name);
                $queryKaryawan = "INSERT INTO karyawan (nik, nama) VALUES ('$pinEscaped', '$nameEscaped') 
                                  ON DUPLICATE KEY UPDATE nama = '$nameEscaped'";
                if (mysqli_query($conn, $queryKaryawan)) {
                    $logger->info("ðŸ‘¤ USER SYNCED: NIK=$pin | Nama=$name");
                }
            }
        }
        echo "OK";
        exit;
    }
    if ($method === 'GET') {
        $logger->info("ðŸ”— ADMS Handshake [GET] dari mesin");
        echo "GET OPTION FROM: 1\r\n";
        echo "Stamp=9999999999\r\n";
        echo "OpStamp=9999\r\n";
        echo "PhotoStamp=0\r\n";
        echo "ErrorDelay=60\r\n";
        echo "Delay=30\r\n";
        echo "TransTimes=00:00;23:59\r\n";
        echo "TransInterval=1\r\n";
        echo "TransFlag=1111111111\r\n";
        echo "Realtime=1\r\n";
        echo "Encrypt=0\r\n";
        exit;
    }
} catch (Exception $e) {
    error_log("CDATA Error: " . $e->getMessage());
    echo "ERROR";
}